<div class="page-header">
  <h1 class="text-success">Upload or edit a document <small>You can upload a file and/or paste the content here</small></h1>
</div>

<div id="error"> </div>

<!-- Place inside the <head> of your HTML -->
<script src="http://cdn.ckeditor.com/4.4.6/standard/ckeditor.js"></script>


<img id="upload-pic-link" onclick="upload_pic();" src="http://lotus-zen.com/btn/upload-pic-btn.png"/>
<input id="insertImgInput" onchange="insertAjax()" name="insertImgInput" type="file" style="display:none" multiple/><br>


<div id="uploaded_files">
%{
(defn get-file-html [doc-id file]
    (str "<div id='existed_file_div_" (file :name) "'>"
        "<a href='" l/uploaded-file-path (file :name) "'>" (file :name) "</a>"
        "<img onclick='delete_uploaded_file(\"" doc-id ", " (file :name) "\")' src='http://lotus-zen.com/btn/del-btn.png'/>"
        "</div>"))

(if-let [doc-id (params :doc-id)]
    (let [query (str "select name from upload_files where doc_id='" doc-id "'")
          conn  (DriverManager/getConnection l/bokwang-db-url)
            stmt (.createStatement conn)
            files (resultset-seq (.executeQuery stmt query))
            dummy (.close conn)
            ]
        (reduce str (map #(get-file-html doc-id %) files))))
}
</div>

<form class="form-inline" id="upload_form" action="/upload" method="post" enctype="multipart/form-data">
   Categories:
    <div class="form-group">
      <label for="exampleInputName2">Zen</label>
      <input class="form-control" id="checkbox_zen" type="checkbox" name="category" value="zen">
    </div>
    <div class="form-group">
      <label for="exampleInputEmail2">Qigong</label>
      <input class="form-control" id="checkbox_qigong" type="checkbox" name="category" value="qigong">
    </div>
    <div class="form-group">
      <label for="exampleInputEmail2">Other</label>
      <input class="form-control" id="checkbox_other" type="text" name="category"/>
    </div>

    <button id="upload_f" type="submit" class="btn btn-default">Submit</button>

    level <input id="doc_level" type="text" name="level"/><br>
  	document title <input id="doc_title" type="text" name="title"/><br>

  	<textarea name="content" id="editor1" rows="10" cols="10"></textarea>

    <button type="button" onclick="more_upload_tag ()" >Add Files</button>

</form>






<script>
function delete_uploaded_file(doc, file){
    alert(doc, file);
}

var div_count = 2;
$("#upload_form").append(upload_div(0));
$("#upload_form").append(upload_div(1));

function upload_div(number){
    var id = "div_upload_" + number;
    var tag = '<div id="' + id + '">' +
        '<input name="files" type="file" multiple/>' +
        '<img onclick="delete_div(\'' + id + '\');" src="http://lotus-zen.com/btn/del-btn.png"/>' +
        '<br>' +
        '</div>';
    return tag;
}

function delete_div (id){
    $("#" + id).html('');
}

function more_upload_tag (){
    $("#upload_form").append(upload_div(div_count));
    div_count ++;

    $("#upload_form").append(upload_div(div_count));
    div_count ++;
}

CKEDITOR.replace( 'editor1', {
    height: '500', 
    width: '1000',
    on: {
    	instanceReady: function() {
           // this is current editor instance
           //this.insertHtml('<h1>someText</h1>');
       	}
    }
});

function upload_pic (){
    $("#insertImgInput").click();
}

function insertAjax (){
    var file = document.getElementById("insertImgInput");
    var fd = new FormData();    
    fd.append('file', file.files[0]);

    $.ajax({
        url: 'http://lotus-zen.com/file',
        data: fd,
        processData: false,
        contentType: false,
        type: 'POST',
        success: function(data){
            $("#error").html("");

            if (data.charAt(0) == '<'){
               CKEDITOR.instances.editor1.insertHtml(data);
            }
            else{
                $("#error").html(data);
            }
        }
    });
}

</script>













